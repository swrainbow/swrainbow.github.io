---
title: 基于物理的渲染(PBR)-01-(Cook-Torrance)
date: 2023-07-13 17:16:02
tags: [图形学]
categories: [PBR]
---
# BRDF
所有限制在**物体表面**的光线传播满足BRDF
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713185518.png)

渲染方程
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713190151.png)
# Cook-Torrance BRDF着色模型

![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713173950.png)


而从本质上而言，Disney Principled BRDF模型是金属和非金属的混合型模型，最终结果是基于金属度（metallice）在金属BRDF和非金属BRDF之间进行线性插值


**Cook-Torrance BRDF兼有漫反射和镜面反射两个部分**：
$f_{r}=k_{d}f_{lambert}+k_{s}f_{cook−torrance}$

这里的kd
是早先提到过的入射光线中被折射部分的能量所占的比率，而ks
是被反射部分的比率。BRDF的左侧表示的是漫反射部分，这里用$f_{lambert}$
来表示。它被称为Lambertian漫反射，这和我们之前在漫反射着色中使用的常数因子类似，用如下的公式来表示

$f_{lambert}=\frac{C}{π}$

c表示表面颜色（回想一下漫反射表面纹理）。除以π
是为了对漫反射光进行标准化，因为前面含有BRDF的积分方程是受π
影响的（我们会在IBL的教程中探讨这个问题的）

目前存在着许多不同类型的模型来实现BRDF的漫反射部分，大多看上去都相当真实，但是相应的运算开销也非常的昂贵。不过按照Epic公司给出的结论，Lambertian漫反射模型已经足够应付大多数实时渲染的用途了。

BRDF的镜面反射部分要稍微更高级一些，它的形式如下所示：
$f_{cook−torrance}=\frac{DFG}{4(ωo⋅n)(ωi⋅n)}$

Cook-Torrance BRDF的镜面反射部分包含三个函数，此外分母部分还有一个标准化因子 。字母D，F与G分别代表着一种类型的函数，各个函数分别用来近似的计算出表面反射特性的一个特定部分。三个函数分别为法线分布函数(Normal Distribution Function)，菲涅尔方程(Fresnel Rquation)和几何函数(Geometry Function)：

- 法线分布函数：估算在受到表面粗糙度的影响下，朝向方向与半程向量一致的微平面的数量。这是用来估算微平面的主要函数。
- 几何函数：描述了微平面自成阴影的属性。当一个平面相对比较粗糙的时候，平面表面上的微平面有可能挡住其他的微平面从而减少表面所反射的光线。
- 菲涅尔方程：菲涅尔方程描述的是在不同的表面角下表面所反射的光线所占的比率。

关于Cook-Torrance BRDF，需要强调的两点注意事项：

对于分母中的点积，仅仅避免负值是不够的 - 也必须避免零值。通常通过在常规的clamp或绝对值操作之后添加非常小的正值来完成。

Microfacet Cook-Torrance BRDF是实践中使用最广泛的模型，实际上也是人们可以想到的最简单的微平面模型。它仅对几何光学系统中的单层微表面上的单个散射进行建模，没有考虑多次散射，分层材质，以及衍射。Microfacet模型，实际上还有很长的路要走。

下面对Microfacet Cook-Torrance BRDF中的D、F、G项分别进行简要说明。

## 法线分布函数 Specular D
描述微面元法线分布的概率，即正确朝向的法线的浓度。即具有正确朝向，能够将来自l的光反射到v的表面点的相对于表面面积的浓度。
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713194824.png)
其中，业界较为主流的法线分布函数是GGX（Trowbridge-Reitz），因为具有更好的高光长尾：
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713195302.png)
在这里h表示用来与平面上微平面做比较用的半程向量，而a
表示表面粗糙度。
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713195341.png)
如果我们把h
当成是不同粗糙度参数下，平面法向量和光线方向向量之间的中间向量的话，我们可以得到如下图示的效果：
举例来说，假设给定向量h，如果我们的微平面中有35%与向量h
取向一致，则法线分布函数或者说NDF将会返回0.35。目前有很多种NDF都可以从统计学上来估算微平面的总体取向度，只要给定一些粗糙度的参数
当粗糙度很低（也就是说表面很光滑）的时候，与半程向量取向一致的微平面会高度集中在一个很小的半径范围内。由于这种集中性，NDF最终会生成一个非常明亮的斑点。但是当表面比较粗糙的时候，微平面的取向方向会更加的随机。你将会发现与h
向量取向一致的微平面分布在一个大得多的半径范围内，但是同时较低的集中性也会让我们的最终效果显得更加灰暗。

## Specular G 几何函数
几何函数从统计学上近似的求得了微平面间相互遮蔽的比率，这种相互遮蔽会损耗光线的能量。

![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713195704.png)

与NDF类似，几何函数采用一个材料的粗糙度参数作为输入参数，粗糙度较高的表面其微平面间相互遮蔽的概率就越高。我们将要使用的几何函数是GGX与Schlick-Beckmann近似的结合体，因此又称为Schlick-GGX：

$GSchlickGGX(n,v,k)=\frac{n⋅v}{(n⋅v)(1−k)+k}$

为了有效的估算几何部分，需要将观察方向（几何遮蔽(Geometry Obstruction)）和光线方向向量（几何阴影(Geometry Shadowing)）都考虑进去。我们可以使用史密斯法(Smith’s method)来把两者都纳入其中：

G(n,v,l,k)=Gsub(n,v,k)Gsub(n,l,k)
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713200955.png)
几何函数是一个值域为[0.0, 1.0]的乘数，其中白色或者说1.0表示没有微平面阴影，而黑色或者说0.0则表示微平面彻底被遮蔽。

## Specular F
菲涅尔效应（Fresnel effect）作为基于物理的渲染理念中的核心理念之一，表示的是看到的光线的反射率与视角相关的现象，由法国物理学家奥古斯丁.菲涅尔率先发现。其具体表现是在掠射角（与法线呈接近90度）下光的反射率会增加。而上述的反射率，便被称为菲涅尔反射率。如下图。
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713201151.png)
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713201203.png)
简单来说，菲涅尔效应即描述视线垂直于表面时反射较弱，而当视线非垂直表面时，夹角越小，反射越明显的一种现象。比如说，当我们站在湖边低头看脚下的湖水，会发现水是透明的，反射不会特别强烈；而如果我们看远处的湖面时，会发现水并不透明，而且反射非常强烈。

菲涅尔方程是一个相当复杂的方程式，不过幸运的是菲涅尔方程可以用Fresnel-Schlick近似法求得近似解：
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713201421.png)

菲涅尔方程还存在一些细微的问题。其中一个问题是Fresnel-Schlick近似仅仅对电介质或者说非金属表面有定义。对于导体(Conductor)表面（金属），使用它们的折射指数计算基础折射率并不能得出正确的结果，这样我们就需要使用一种不同的菲涅尔方程来对导体表面进行计算。由于这样很不方便，所以我们预计算出平面对于法向入射的结果（F0
，处于0度角，好像直接看向表面一样），然后基于相应观察角的Fresnel-Schlick近似对这个值进行插值，用这种方法来进行进一步的估算。这样我们就能对金属和非金属材质使用同一个公式了。
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713201759.png)
这里可以观察到的一个有趣的现象，所有电介质材质表面的基础反射率都不会高于0.17，这其实是例外而非普遍情况。导体材质表面的基础反射率起点更高一些并且（大多）在0.5和1.0之间变化。此外，对于导体或者金属表面而言基础反射率一般是带有色彩的，这也是为什么F0
要用RGB三原色来表示的原因（法向入射的反射率可随波长不同而不同）。这种现象我们只能在金属表面观察的到。

通过预先计算电介质与导体的F0
值，我们可以对两种类型的表面使用相同的Fresnel-Schlick近似，但是如果是金属表面的话就需要对基础反射率添加色彩。我们一般是按下面这样来实现的
```glsl
vec3 F0 = vec3(0.04);
F0      = mix(F0, surfaceColor.rgb, metalness);
```

```glsl
//Fresnel Schlick近似可以用代码表示为：
vec3 fresnelSchlick(float cosTheta, vec3 F0)
{
    return F0 + (1.0 - F0) * pow(1.0 - cosTheta, 5.0);
}
```

## Cook-Torrance反射率方程
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713202303.png)
这个方程现在完整的描述了一个基于物理的渲染模型，它现在可以认为就是我们一般意义上理解的基于物理的渲染也就是PBR。
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713225047.png)

# 基于图像的光照
IBL 通常使用（取自现实世界或从3D场景生成的）环境立方体贴图 (Cubemap) ，我们可以将立方体贴图的每个像素视为光源，在渲染方程中直接使用它。这种方式可以有效地捕捉环境的全局光照和氛围，使物体更好地融入其环境。

由于基于图像的光照算法会捕捉部分甚至全部的环境光照，通常认为它是一种更精确的环境光照输入格式，甚至也可以说是一种全局光照的粗略近似。基于此特性，IBL 对 PBR 很有意义，因为当我们将环境光纳入计算之后，物体在物理方面看起来会更加准确。


如前所述，我们的主要目标是计算半球 Ω上所有入射光方向 wi的积分。解决上一节教程中的积分非常简单，因为我们事先已经知道了对积分有贡献的、若干精确的光线方向 wi。然而这次，来自周围环境的每个方向 wi的入射光都可能具有一些辐射度，使得解决积分变得不那么简单。这为解决积分提出了两个要求：

- 给定任何方向向量 wi ，我们需要一些方法来获取这个方向上场景的辐射度。
- 解决积分需要快速且实时。

现在看，第一个要求相对容易些。我们已经有了一些思路：表示环境或场景辐照度的一种方式是（预处理过的）环境立方体贴图，给定这样的立方体贴图，我们可以将立方体贴图的每个纹素视为一个光源。使用一个方向向量 wi对此立方体贴图进行采样，我们就可以获取该方向上的场景辐照度。

如此，给定方向向量 wi，获取此方向上场景辐射度的方法就简化为：
```glsl
vec3 radiance =  texture(_cubemapEnvironment, w_i).rgb;
```
为了以更有效的方式解决积分，我们需要对其大部分结果进行预处理——或称预计算。为此，我们必须深入研究反射方程:
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713202303.png)

通过将积分分成两部分，我们可以分开研究漫反射和镜面反射部分
![](https://strainbow.oss-cn-hangzhou.aliyuncs.com/20230713230134.png)